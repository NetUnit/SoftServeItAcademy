{%extends 'base.html'%}

{%block title%} Twitter Login {%endblock%} 

{%load crispy_forms_tags%} 

{%block content%}

{% load static %}

{%load crispy_forms_tags%}

<head>
<title>Twitter Login Example</title>
<meta charset="UTF-8">
</head>

<body>
  <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  
  <!-- defines style for social auth buttons specifically -->
  <link rel="stylesheet" href="{% static 'css/social_buttons.css' %}">

  <script>




  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      // alert('Cookies' + cookies)
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    // alert('Cookie Value' + cookieValue)
    return cookieValue;
  }

  const csrftoken = getCookie('csrftoken');

  // Finalize POST request to the backend
  // Responsible for the authentication also

  function formData(IdToken, User, Email) {
    var url = "{% url 'accounts_api:twitter-user-login-test' %}"

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        // redirect: 'follow', // manual, *follow, error
        body:JSON.stringify({'IdToken': IdToken, 'User': User, 'Email': Email})
    })
  }

  function FinalizeResponse(IdToken, User, Email) {

    // redirect urls
    // var url1 = "{% url 'index' %}" // main page

    var url1 = "{% url 'accounts:profile' %}"
    var url2 = "{% url 'accounts:login-success' %}"
    var url3 = "{% url 'accounts:login_failed' %}"
    var url4 = "{% url 'accounts:login_cbv' %}"
    
    var same_email = email === Email

    if (!same_email && user !== 'AnonymousUser') {
      
      if (confirm('1. U will be sighedin as: ' + User +
        "\n\n and logout from: " + user)) { 
        // Save it!
        formData(IdToken, User);
        alert('U\'ve signed in as: ' + User);
        location.replace(url2);
      } else {
        // Do nothing!
        alert('U\'ve passed the login for: ' + User);
        location.replace(url4);
      }
    }

    else if (same_email) {
      alert('2. U\'ve already sighed-in as: ' + User)
      location.replace(url1);
    }

    else if ('AnonymousUser') {
      // alert('3: U will be sighedin as: ' + User)
      // add on approve

      if (confirm('1. U will be sighedin as: ' + User)) {
        // Save it!
        formData(IdToken, User);
        alert('U\'ve signed in as: ' + User);
        location.replace(url2);
      } else {
        // Do nothing!
        alert('U\'ve passed the login for: ' + User);
        location.replace(url4);
      }
    }

    else {
      alert('Login failed for: ' + User)
      // add on approve
      // FinalizeResponse(IdToken, User);
      location.replace(url3);
    }
  }

  </script>

<div class="container">
  <div class="row">
    <div class="col-md-6 mx-auto mt-5">
      <div class="header1">
        <div class="header2">
          <div class="check"> <i class="fa fa-dot-circle-o"></i></div>
        </div>
        <div class="content">
          <h1> U're going to login with twitter as a: </h1>
          <h2> {{ user }} </h2>
          <p>
            <form action="." method="post" enctype="multipart/form-data">
              {% csrf_token %}

            </form>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
</body>

{% endblock %}