<head>
  <title>Facebook Login JavaScript Example</title>
  <meta charset="UTF-8">
  </head>
  <body>
  <script>
  
    function statusChangeCallback(response) {  // Called with the results from FB.getLoginStatus().
      console.log('statusChangeCallback');
      console.log(response);                   // The current login status of the person.
      if (response.status === 'connected') {   // Logged into your webpage and Facebook.
        testAPI();  
      } else {                                 // Not logged into your webpage or we are unable to tell.
        document.getElementById('status').innerHTML = 'Please log ' +
          'into this webpage.';
      }
    }

    function checkLoginState() {               // Called when a person is finished with the Login Button.
      FB.getLoginStatus(function(response) {   // See the onlogin handler
        statusChangeCallback(response);
      });
    }
  
  
    window.fbAsyncInit = function() {
      FB.init({
        appId      : '1026623988292715',
        cookie     : true,                     // Enable cookies to allow the server to access the session.
        xfbml      : true,                     // Parse social plugins on this webpage.
        version    : 'v13.0'           // Use this Graph API version for this call.
      });
  
  
      FB.getLoginStatus(function(response) {   // Called after the JS SDK has been initialized.
        statusChangeCallback(response);        // Returns the login status.
      });
    };

    // Testing Graph API after login.  See statusChangeCallback() for when this call is made.
    // photos - ptianl key for iuser photos
    // picture / profile picture
    
    function testAPI() {                      
      console.log('Welcome!  Fetching your information.... ');
      FB.api('/me', {"fields": "id,name,email"}, function(response) {
        console.log('Successful login for: ' + response.name);
        document.getElementById('status').innerHTML =
          'Thanks for logging in, ' + response.photo + response.name + '!' + response.email;

          const Response = response
          const User = response.name
          const Email = response.email
          //const Picture = response.picture

          bbb = JSON.stringify(response)

          alert(bbb)

          FinalizeResponse(Response, User, Email)

          // alert("This is response: " + response.name)
          // var a = [];
          // Object.entries(response).forEach(itm=>a.push({key: itm[0], value: itm[1]}));
          // alert(a[0])
          // var b = a[0]
          // var c = []
          // Object.entries(b).forEach(itm=>c.push({key: itm[0], value: itm[1]}));
          // alert(c)
      });
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        
        alert('Cookies' + cookies)
        
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
    
    alert('Cookie Value' + cookieValue)
    return cookieValue;
  }


  // alert(Response)
  // const csrftoken = getCookie('csrftoken')

  // Finalize POST request to the backend
  // Responsible for the authentication also

  var email = '{{ user.email }}'
  var user = '{{ user }}'

  function formData(Response, User, Email) {
    var url = "{% url 'fb-user-login-test' %}"

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        // redirect: 'follow', // manual, *follow, error
        body:JSON.stringify({'response': Response, 'User': User, 'Email': Email})
    })
  }

  function FinalizeResponse(Response, User, Email) {
    var url1 = "{% url 'accounts:profile' %}"
    var url2 = "{% url 'accounts:login-success' %}"
    var url3 = "{% url 'accounts:login_failed' %}"
    var url4 = "{% url 'fb-user-login-test' %}"

    var same_email = email === Email

    if (!same_email && user !== 'AnonymousUser') {
      
      if (confirm('1. U will be sighedin as: ' + User +
        "\n\n and logout from: " + user)) { 
        // Save it!
        formData(Response, User, Email);
        alert('U\'ve signed in as: ' + User);
        location.replace(url2);
      } else {
        // Do nothing!
        alert('U\'ve passed the login for: ' + User);
        location.replace(url4);
      }
    }

    else if (same_email) {
      alert('2. U\'ve already sighed-in as: ' + User)
      location.replace(url1);
    }

    else if ('AnonymousUser') {
      // alert('3: U will be sighedin as: ' + User)
      // add on approve

      if (confirm('1. U will be sighedin as: ' + User)) {
        // Save it!
        formData(Response, User, Email);
        alert('U\'ve signed in as: ' + User);
        location.replace(url2);
      } else {
        // Do nothing!
        alert('U\'ve passed the login for: ' + User);
        location.replace(url4);
      }
    }

    else {
      alert('Login failed for: ' + User)
      // add on approve
      // FinalizeResponse(IdToken, User);
      location.replace(url3);
    }
  }
  
  </script>
  
  <!-- The JS SDK Login Button -->
  <form action="." method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <fb:login-button scope="public_profile,email" onlogin="checkLoginState();">
    </fb:login-button>
    
    <div id="status">
    </div>
    
    <!-- Load the JS SDK asynchronously -->
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>
  </form>
</body>